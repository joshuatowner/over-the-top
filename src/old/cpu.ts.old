import Two = require("two.js");
import CoreLoad from "./coreLoad";
import LoadHistory from "./loadHistory";
import OverallLoad from "./overallLoad";
import {CpuInfo} from "../../data/cpu";
import {cpuInfo, cpuUsageUpdate} from "../../backend/cpu";
import {getConfig} from "../../config";
import {setIntervalImmediate} from "../../util/timing";

interface CpuComponentSizes {
    coresInnerRadius: number,
    coresOuterRadius: number,
    historyInnerRadius: number,
    historyOuterRadius: number,
}

export default class CpuUI {

    size: Size
    two: Two;
    cores?: CoreLoad;
    history?: LoadHistory;
    overallLoad?: OverallLoad;

    constructor(two: Two, size: Size) {
        this.size = size;
        this.two = two;
        this.startTimers();
        cpuInfo().then((info) => this.init(info));
    }

    private init(info: CpuInfo): void {
        const center = this.getCenter();
        const sizes = this.getSizes();
        const updateInterval = getConfig().cpu.timing.updateInterval;
        const historyNumSegments = getConfig().cpu.ui.sizing.historyNumSegments;
        this.cores = new CoreLoad(
            this.two, center,
            sizes.coresInnerRadius, sizes.coresOuterRadius,
            updateInterval, info.cores
        );
        this.history = new LoadHistory(
            this.two, center,
            sizes.historyInnerRadius, sizes.historyOuterRadius,
            historyNumSegments, updateInterval,
        );
        this.overallLoad = new OverallLoad(this.two, center, sizes.coresInnerRadius);
        this.two.update();
    }

    private startTimers(): void {
        setIntervalImmediate(() => this.update(), getConfig().cpu.timing.updateInterval);
    }

    private async update(): Promise<void> {
        const load = await cpuUsageUpdate();
        this.cores?.update(load.coreUsages);
        this.history?.update(load.overallUsage);
        this.overallLoad?.update(load.overallUsage);
    }

    private getSizes(): CpuComponentSizes {
        const fullRadius = Math.min(this.size.width, this.size.height) / 2;
        const configSizes = getConfig().cpu.ui.sizing;
        return {
            coresInnerRadius: fullRadius * configSizes.coresStart,
            coresOuterRadius: fullRadius * configSizes.coresEnd,
            historyInnerRadius: fullRadius * configSizes.historyStart,
            historyOuterRadius: fullRadius * configSizes.historyEnd,
        }
    }

    private getCenter(): Vec2 {
        return {
            x: this.size.width / 2,
            y: this.size.height / 2
        }
    }

}
